<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Statement Validation</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    body {
      background-color: #f3f4f6;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      margin: 0;
    }
    .main-content {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      flex: 1;
      padding: 16px;
      margin-top: 80px;
    }
    .container {
      width: 100%;
      max-width: 600px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 24px;
      margin-bottom: 16px;
    }
    h1 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 16px;
      color: #6c5ce7;
    }
    #progress-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 24px;
    }
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #ddd;
      margin: 0 6px;
    }
    .progress-dot.active {
      background-color: #6c5ce7;
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .field {
      margin-bottom: 16px;
    }
    .field label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    input[type="text"] {
      border: 2px solid #ddd;
      border-radius: 6px;
    }
    .fact-input-container {
      display: flex;
      align-items: center;
    }
    .fact-input {
      flex: 1;
      padding: 10px;
      margin-right: 8px;
    }
    .fact-add-button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background-color: #e9d5ff;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
      height: 100%;
    }
    .fact-add-button:hover {
      background-color: #bfdbfe;
    }
    .facts-list {
      list-style: none;
      padding-left: 0;
      margin-top: 12px;
    }
    .facts-list li {
      padding: 8px;
      margin: 6px 0;
      border-left: 4px solid #e9d5ff;
      background-color: #fafafa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .remove-fact {
      background: none;
      border: none;
      color: #b91c1c;
      font-weight: bold;
      cursor: pointer;
    }
    .materiality-item {
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      background-color: #fafafa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .materiality-label {
      margin-right: 8px;
      flex: 1;
    }
    .materiality-buttons {
      display: flex;
      gap: 8px;
    }
    .materiality-button {
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .yes-button {
      background-color: #bbf7d0;
    }
    .yes-button:hover {
      background-color: #86efac;
    }
    .no-button {
      background-color: #fecdd3;
    }
    .no-button:hover {
      background-color: #fda4af;
    }
    .additional-proof-container {
      margin-top: 16px;
      border-top: 1px solid #ddd;
      padding-top: 16px;
    }
    .proof-fact-title {
      font-weight: bold;
      margin-bottom: 8px;
    }
    .proof-list {
      margin-top: 8px;
      padding-left: 0;
      list-style-type: none;
    }
    .proof-list-item {
      padding: 8px;
      margin: 6px 0;
      border-left: 4px solid #cbd5e1;
      background-color: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .proof-input-container {
      display: flex;
      align-items: center;
      margin-top: 8px;
    }
    .proof-input {
      flex: 1;
      padding: 8px;
      margin-right: 8px;
      border: 2px solid #ddd;
      border-radius: 6px;
    }
    .proof-add-button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background-color: #e9d5ff;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .proof-add-button:hover {
      background-color: #bfdbfe;
    }
    .remove-proof {
      background: none;
      border: none;
      color: #b91c1c;
      font-weight: bold;
      cursor: pointer;
      margin-left: 8px;
    }
    .buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
    }
    .buttons button {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      background-color: #e9d5ff;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .buttons button:hover {
      background-color: #bfdbfe;
    }
    .buttons button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .result-box {
      padding: 16px;
      margin-top: 16px;
      font-weight: bold;
      text-align: center;
      border-radius: 8px;
      color: #333;
    }
    #history-container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto 24px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 24px;
      display: none;
    }
    #history-list {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .history-item {
      padding: 12px;
      border-radius: 6px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .history-label {
      flex: 1;
      margin-right: 16px;
    }
    .history-item-buttons {
      display: flex;
      gap: 12px;
    }
    .delete-button {
      border: none;
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
      font-weight: bold;
      background-color: #eee;
      transition: background-color 0.3s ease;
    }
    .delete-button:hover {
      background-color: #fecdd3;
    }
    .clear-all-button {
      margin-top: 12px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      background-color: #eee;
      transition: background-color 0.3s ease;
    }
    .clear-all-button:hover {
      background-color: #fecdd3;
    }
    #export-pdf {
      margin-top: 12px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      background-color: #eee;
      transition: background-color 0.3s ease;
      margin-left: 16px;
    }
    #export-pdf:hover {
      background-color: #bfdbfe;
    }
    #export-json {
      margin-top: 12px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      background-color: #eee;
      transition: background-color 0.3s ease;
      margin-left: 16px;
    }
    #export-json:hover {
      background-color: #bfdbfe;
    }
    #import-json {
      margin-top: 12px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      background-color: #eee;
      transition: background-color 0.3s ease;
      margin-left: 16px;
    }
    #import-json:hover {
      background-color: #bfdbfe;
    }
    .history-footer {
      margin-top: 16px;
      padding: 12px;
      border-radius: 6px;
      font-weight: bold;
      text-align: center;
    }
    .bg-green {
      background-color: lightgreen;
    }
    .bg-red {
      background-color: lightcoral;
    }
    .bg-orange {
      background-color: #FFDAB9;
    }
    @media (max-width: 600px) {
      .container {
        width: 100%;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
      }
      #history-container {
        width: 100%;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
      }
    }
    @media print {
      .main-content {
        display: none;
      }
      #history-container {
        display: block !important;
      }
    }
  </style>
</head>
<body>
  <div class="main-content">
    <div class="container">
      <h1>Statement Validation</h1>
      <div id="progress-bar">
        <div class="progress-dot active"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
        <div class="progress-dot"></div>
      </div>

      <!-- Step 1: Enter Statement -->
      <div id="step1" class="step active">
        <div id="edit-mode-message" style="display:none; margin-top:8px; color:#b91c1c; font-weight:bold;">
          Currently editing an existing statement...
        </div>
        <form id="form-step1">
          <div class="field">
            <label for="statement-input">Enter your statement</label>
            <input
              type="text"
              id="statement-input"
              placeholder="Example: Water boils at 100°C"
              required
              style="width:100%; padding:10px;"
            />
          </div>
          <div class="buttons">
            <button type="button" id="prev1" disabled>Previous</button>
            <button type="submit" id="next1">Next</button>
          </div>
        </form>

        <!-- NEW BLOCK: Import/Export JSON -->
        <div style="margin-top:30px; border-top:1px solid #ddd; padding-top:20px;">
          <button id="import-json">Import Memory from JSON</button>
          <button id="export-json">Export Memory as JSON</button>
        </div>
        <!-- End NEW BLOCK -->
      </div>

      <!-- Step 2: List Facts -->
      <div id="step2" class="step">
        <p id="statement-text" style="font-weight:bold;"></p>
        <form id="form-step2">
          <div class="field">
            <label for="fact-input">List the facts needed to be TRUE to prove this statement</label>
            <div class="fact-input-container">
              <input
                type="text"
                id="fact-input"
                class="fact-input"
                placeholder="Example: Water is liquid at room temperature"
              />
              <button type="button" class="fact-add-button" id="add-fact-btn">Add</button>
            </div>
            <ul class="facts-list" id="facts-list"></ul>
          </div>
          <div class="buttons">
            <button type="button" id="prev2">Previous</button>
            <button type="submit" id="next2">Next</button>
          </div>
        </form>
      </div>

      <!-- Step 3: Materiality (Yes/No) for each Fact -->
      <div id="step3" class="step">
        <p>For each fact, indicate if there is scientific materiality:</p>
        <div id="materiality-container"></div>
        <div class="buttons">
          <button type="button" id="prev3">Previous</button>
          <button type="button" id="next3">Next</button>
        </div>
      </div>

      <!-- Step 4: Optional Materialities for each Fact -->
      <div id="step4" class="step">
        <p>Optionally, add proofs/materialities for facts declared <em>true</em>:</p>
        <div id="additional-proof-wrapper"></div>
        <div class="buttons">
          <button type="button" id="prev4">Previous</button>
          <button type="button" id="next4">Next</button>
        </div>
      </div>

      <!-- Step 5: Final Result -->
      <div id="step5" class="step">
        <div id="result-box" class="result-box"></div>
        <div class="buttons">
          <button type="button" id="prev5">Previous</button>
          <button type="button" id="restart">New analysis</button>
        </div>
      </div>

    </div>
  </div>

  <!-- History Container -->
  <div id="history-container">
    <h2>History of Evaluations</h2>
    <div id="history-list"></div>
    <div id="history-footer" class="history-footer"></div>
    <button id="clear-all" class="clear-all-button">Clear All</button>
    <button id="export-pdf">Export to PDF</button>
  </div>

  <script>
    // ---------------------------
    // Global variables
    // ---------------------------
    let currentStep = 1;
    let statement = "";
    let facts = [];
    // factsMateriality[index] = boolean (true/false) or null if not yet selected
    let factsMateriality = [];
    // factsProofs[index] = array of strings (the materials entered)
    let factsProofs = [];
    
    let verifiedCount = 0;
    let verifiedPct = 0; // de 0 à 100
    let isStatementTrue = false;

    // IndexedDB
    let db = null;

    // History in memory
    let savedStatements = [];
    // Self-incrementing ID generator
    let autoIncrementID = 1;
    // ID of record being edited (null = created)
    let currentlyEditingID = null;

    // ---------------------------
    // DOM Elements
    // ---------------------------
    const steps = {
      1: document.getElementById("step1"),
      2: document.getElementById("step2"),
      3: document.getElementById("step3"),
      4: document.getElementById("step4"),
      5: document.getElementById("step5")
    };
    const progressDots = document.querySelectorAll("#progress-bar .progress-dot");
    
    const formStep1 = document.getElementById("form-step1");
    const statementInput = document.getElementById("statement-input");

    const formStep2 = document.getElementById("form-step2");
    const factInput = document.getElementById("fact-input");
    const addFactBtn = document.getElementById("add-fact-btn");
    const factsList = document.getElementById("facts-list");
    const statementText = document.getElementById("statement-text");

    const materialityContainer = document.getElementById("materiality-container");

    const additionalProofWrapper = document.getElementById("additional-proof-wrapper");

    const resultBox = document.getElementById("result-box");

    const historyContainer = document.getElementById("history-container");
    const historyList = document.getElementById("history-list");
    const historyFooter = document.getElementById("history-footer");
    const clearAllBtn = document.getElementById("clear-all");
    const exportPdfBtn = document.getElementById("export-pdf");

    // Import/Export JSON
    const exportJsonBtn = document.getElementById("export-json");
    const importJsonBtn = document.getElementById("import-json");

    // ---------------------------
    // Step navigation
    // ---------------------------
    function goToStep(n) {
      steps[currentStep].classList.remove("active");
      currentStep = n;
      steps[currentStep].classList.add("active");
      updateProgressBar();
    }

    function updateProgressBar() {
      progressDots.forEach((dot, i) => {
        if (i+1 === currentStep) dot.classList.add("active");
        else dot.classList.remove("active");
      });
    }

    // ---------------------------
    // IndexedDB init
    // ---------------------------
    let request = window.indexedDB.open("StatementDB", 1);
    request.onerror = function() {
      console.error("IndexedDB error");
    };
    request.onsuccess = function(e) {
      db = e.target.result;
      loadFromDB();
    };
    request.onupgradeneeded = function(e) {
      db = e.target.result;
      if(!db.objectStoreNames.contains("statements")) {
        db.createObjectStore("statements", { keyPath: "id" });
      }
    };

    function loadFromDB() {
      let txn = db.transaction(["statements"], "readonly");
      let store = txn.objectStore("statements");
      let getAll = store.getAll();
      getAll.onsuccess = function(e) {
        savedStatements = e.target.result || [];
        renderHistory();
      };
    }

    function deleteFromDB(id) {
      let txn = db.transaction(["statements"], "readwrite");
      let store = txn.objectStore("statements");
      store.delete(id);
    }

    // ---------------------------
    // Step 1
    // ---------------------------
    formStep1.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!statementInput.value.trim()) return;
      statement = statementInput.value.trim();
      statementText.textContent = "Statement: " + statement;
      goToStep(2);
    });
    document.getElementById("prev1").disabled = true;

    // Export JSON
    exportJsonBtn.addEventListener("click", () => {
      // We serialize all history
      let data = JSON.stringify(savedStatements, null, 2);
      // We create a Blob "text/json"
      let blob = new Blob([data], {type: "application/json"});
      // Temporary URL
      let url = URL.createObjectURL(blob);

      // Creating an "invisible" link to force the download
      let a = document.createElement("a");
      a.href = url;
      a.download = "factcheck_memory.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Import JSON
    importJsonBtn.addEventListener("click", () => {
      let fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'application/json';
      fileInput.onchange = (evt) => {
        let file = evt.target.files[0];
        if (!file) return; // l'utilisateur a fermé sans sélectionner de fichier

        let reader = new FileReader();
        reader.onload = function(e) {
          let content = e.target.result;
          try {
            let data = JSON.parse(content);

            // Assume “data” is the array savedStatements
            if (!Array.isArray(data)) {
              alert("Invalid JSON format.");
              return;
            }
            // Overwrite the existing base
            let txn = db.transaction(["statements"], "readwrite");
            let store = txn.objectStore("statements");
            let clearReq = store.clear();
            clearReq.onsuccess = function() {
              // Each entry is recorded
              data.forEach(item => {
                store.put(item);
              });
              // We also update the variable in memory
              savedStatements = data;
              renderHistory();
              resetAllData();
              alert("Import done. History reloaded.");
            };
          } catch(err) {
            console.error(err);
            alert("Error reading JSON file");
          }
        };
        reader.readAsText(file);
      };
      fileInput.click();
    });

    // ---------------------------
    // Step 2
    // ---------------------------
    addFactBtn.addEventListener("click", addFact);
    factInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addFact();
      }
    });

    function addFact() {
      let val = factInput.value.trim();
      if (!val) return;
      facts.push(val);
      // We initialize the value of factsMateriality and factsProofs for this new fact
      factsMateriality.push(null);
      factsProofs.push([]);
      factInput.value = "";
      factInput.focus();
      renderFacts();
    }

    function renderFacts() {
      factsList.innerHTML = "";
      facts.forEach((f, index) => {
        let li = document.createElement("li");
        li.textContent = f;
        let btn = document.createElement("button");
        btn.textContent = "✕";
        btn.className = "remove-fact";
        btn.addEventListener("click", () => {
          facts.splice(index, 1);
          factsMateriality.splice(index, 1);
          factsProofs.splice(index, 1);
          renderFacts();
        });
        li.appendChild(btn);
        factsList.appendChild(li);
      });
    }

    formStep2.addEventListener("submit", (e) => {
      e.preventDefault();
      if (factInput.value.trim()) addFact();
      if (facts.length === 0) return;
      goToStep(3);
      buildMaterialityList();
    });

    document.getElementById("prev2").addEventListener("click", () => {
      goToStep(1);
    });

    // ---------------------------
    // Step 3
    // ---------------------------
    document.getElementById("prev3").addEventListener("click", () => goToStep(2));

    document.getElementById("next3").addEventListener("click", () => {
      if (facts.length === 0) return;
      // Check if everything is checked (true/false)
      if (factsMateriality.includes(null)) {
        alert("Please select Yes/No for all facts before proceeding.");
        return;
      }
      // Score calculation
      verifiedCount = factsMateriality.filter(v => v === true).length;
      verifiedPct = Math.round((verifiedCount / facts.length) * 100);
      isStatementTrue = (verifiedCount === facts.length);
      goToStep(4);
      buildProofsInterface();
      
      if (verifiedCount === 0) {
        // If no fact is true, skip step4 and jump directly to step5
        goToStep(5);
        showResult(true);
        saveCurrentStatement();
      } else {
        // Otherwise, proceed as before
        goToStep(4);
        buildProofsInterface();
      }
      
    });

    function buildMaterialityList() {
      materialityContainer.innerHTML = "";
      facts.forEach((f, index) => {
        let item = document.createElement("div");
        item.className = "materiality-item";

        let label = document.createElement("div");
        label.className = "materiality-label";
        label.textContent = f;

        let btns = document.createElement("div");
        btns.className = "materiality-buttons";

        let yesBtn = document.createElement("button");
        yesBtn.type = "button";
        yesBtn.textContent = "Yes";
        yesBtn.className = "materiality-button yes-button";
        yesBtn.addEventListener("click", () => {
          factsMateriality[index] = true;
          item.style.backgroundColor = "#bbf7d0";
        });

        let noBtn = document.createElement("button");
        noBtn.type = "button";
        noBtn.textContent = "No";
        noBtn.className = "materiality-button no-button";
        noBtn.addEventListener("click", () => {
          factsMateriality[index] = false;
          item.style.backgroundColor = "#fecdd3";
        });

        // Initial color if already selected
        if (factsMateriality[index] === true) {
          item.style.backgroundColor = "#bbf7d0";
        } else if (factsMateriality[index] === false) {
          item.style.backgroundColor = "#fecdd3";
        }

        btns.appendChild(yesBtn);
        btns.appendChild(noBtn);

        item.appendChild(label);
        item.appendChild(btns);

        materialityContainer.appendChild(item);
      });
    }

    // ---------------------------
    // Step 4: Optional proofs for each Fact (only if fact = true)
    // ---------------------------
    document.getElementById("prev4").addEventListener("click", () => {
      goToStep(3);
    });
    document.getElementById("next4").addEventListener("click", () => {
      // We go straight to the conclusion
      goToStep(5);
      showResult(true);
      saveCurrentStatement();
    });

    function buildProofsInterface() {
      additionalProofWrapper.innerHTML = "";
      facts.forEach((fact, idx) => {
        if (factsMateriality[idx] !== true) {
          // Fact not true => the possibility of adding proofs is not displayed
          return;
        }
        let container = document.createElement("div");
        container.className = "additional-proof-container";

        let title = document.createElement("div");
        title.className = "proof-fact-title";
        title.textContent = "Fact: " + fact;
        container.appendChild(title);

        // UL list of proofs
        let ul = document.createElement("ul");
        ul.className = "proof-list";
        container.appendChild(ul);

        // Buttons + field
        let inputContainer = document.createElement("div");
        inputContainer.className = "proof-input-container";
        let proofInput = document.createElement("input");
        proofInput.type = "text";
        proofInput.className = "proof-input";
        proofInput.placeholder = "Add a proof or reference link...";

        let addBtn = document.createElement("button");
        addBtn.type = "button";
        addBtn.className = "proof-add-button";
        addBtn.textContent = "Add";
        addBtn.addEventListener("click", () => {
          let val = proofInput.value.trim();
          if (!val) return;
          factsProofs[idx].push(val);
          proofInput.value = "";
          proofInput.focus();
          renderProofs();
        });

        proofInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            addBtn.click();
          }
        });

        inputContainer.appendChild(proofInput);
        inputContainer.appendChild(addBtn);
        container.appendChild(inputContainer);

        // Rendering function
        function renderProofs() {
          ul.innerHTML = "";
          factsProofs[idx].forEach((p, pIndex) => {
            let li = document.createElement("li");
            li.className = "proof-list-item";
            li.textContent = p;

            let btnRemove = document.createElement("button");
            btnRemove.className = "remove-proof";
            btnRemove.textContent = "✕";
            btnRemove.addEventListener("click", () => {
              factsProofs[idx].splice(pIndex, 1);
              renderProofs();
            });

            li.appendChild(btnRemove);
            ul.appendChild(li);
          });
        }

        // Launch initial rendering
        renderProofs();
        additionalProofWrapper.appendChild(container);
      });
    }

    // ---------------------------
    // Step 5: Final result
    // ---------------------------
    document.getElementById("prev5").addEventListener("click", () => {
      // If there are no true facts, skip step4 when going backward
      if (verifiedCount === 0) {
        goToStep(3);
      } else {
        goToStep(4);
      }
    });
    document.getElementById("restart").addEventListener("click", () => {
      resetAllData();
      goToStep(1);
    });

    function showResult(forceLastDot = false) {
      // Final calculation of veracity color
      let colorClass = "bg-red";
      if (verifiedPct > 90) {
        colorClass = "bg-green";
      } else if (verifiedPct > 50) {
        colorClass = "bg-orange";
      }
      resultBox.textContent = `${statement} : ${verifiedPct}% true`;
      resultBox.className = `result-box ${colorClass}`;
      
      if (forceLastDot) {
        progressDots.forEach(d => d.classList.remove("active"));
        if (progressDots.length >= 5) {
          progressDots[4].classList.add("active");
        }
      }
    }

    // ---------------------------
    // History management
    // ---------------------------
    clearAllBtn.addEventListener("click", () => {
      let txn = db.transaction(["statements"], "readwrite");
      let store = txn.objectStore("statements");
      let clearReq = store.clear();
      clearReq.onsuccess = function() {
        savedStatements = [];
        renderHistory();
        resetAllData();
        goToStep(1);
      };
    });

    exportPdfBtn.addEventListener("click", () => {
        // 1) Prompt user for a report name
        let userTitle = prompt("Enter a report name (leave blank to skip, cancel to abort):","");
        if (userTitle === null) {
          // The user pressed cancel => we do NOT export at all
          return;
        }
        // If blank => fallback to "Report"
        if (!userTitle.trim()) {
          userTitle = "Report";
        } else {
          // Capitalize each word in the custom name
          // e.g. "my example report" => "My Example Report"
          userTitle = userTitle
            .split(/\s+/)
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(" ");
        }
    
        // 2) Compute the average veracity across all statements
        let totalCount = savedStatements.length;
        if (totalCount === 0) {
          alert("No statements to export.");
          return;
        }
        let sumVeracity = 0;
        savedStatements.forEach(s => {
          sumVeracity += s.verifiedPct;
        });
        let avgVeracity = Math.round(sumVeracity / totalCount);
    
        // 3) Determine the prefix
        let prefix = "FALSE"; // default
        if (avgVeracity === 100) {
          prefix = "TRUE";
        } else if (avgVeracity > 50) {
          prefix = "RATHER_TRUE";
        } else if (avgVeracity == 50) {
          prefix = "HALF_TRUE_FALSE";
        } else if (avgVeracity === 0) {
          prefix = "FALSE";
        } else {
          prefix = "RATHER_FALSE";
        }
    
        // 4) Nicely formatted date for display and file name
        // Example format: "March 12, 2025, 14:05"
        let now = new Date();
        let options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        let niceDateDisplay = now.toLocaleString('en-US', options);
    
        // Also build a file-friendly date for the file name, e.g. "2025-03-12_14h05"
        let yyyy = now.getFullYear();
        let mm = String(now.getMonth()+1).padStart(2,'0');
        let dd = String(now.getDate()).padStart(2,'0');
        let hh = String(now.getHours()).padStart(2,'0');
        let min = String(now.getMinutes()).padStart(2,'0');
        let fileDate = `${yyyy}-${mm}-${dd}_${hh}h${min}m`;
    
        // 5) Construct the file name => <PREFIX>-<NoSpacesUserTitle>-<fileDate>
        //    We remove spaces in userTitle by using dashes:
        let titleNoSpaces = userTitle.replace(/\s+/g, '-');
        let fileName = `${prefix}-${titleNoSpaces}-${fileDate}`;
    
        // 6) Build the HTML with a cover page (title, date, count) and
        //    a new page for the table (with anchor links), then detail pages.
        let coverPage = `
          <div class="cover-page" style="page-break-after: always; text-align:center; margin-top:100px;">
            <h1>${escapeHtml(userTitle)}</h1>
            <p>${escapeHtml(niceDateDisplay)}</p>
            <p>${savedStatements.length} statement(s) evaluated</p>
          </div>
        `;
        
        // Table page with anchor links (its own page)
        // Each statement links to "#statement-sIndex"
        let tablePage = `
          <div style="page-break-after: always;">
            <table style="margin-top:50px; border-collapse: collapse; margin-left:auto; margin-right:auto;">
              <tr>
                <th style="border:1px solid #ccc; padding:8px;">Statement</th>
                <th style="border:1px solid #ccc; padding:8px;">Veracity (%)</th>
                <th style="border:1px solid #ccc; padding:8px;">Proofs</th>
              </tr>
        `;
        // Build each row with anchor link
        savedStatements.forEach((s, sIndex) => {
          const veracity = s.verifiedPct;
          const totalProofsCount = (s.factsProofs || []).reduce((acc, arr) => acc + (arr ? arr.length : 0), 0);
    
          // Simple color classification for table row
          let rowColor = "lightcoral"; // red by default
          if (veracity > 90) rowColor = "lightgreen";
          else if (veracity > 50) rowColor = "#FFDAB9";
    
          tablePage += `
            <tr style="background-color:${rowColor};">
              <td style="border:1px solid #ccc; padding:8px;">
                <a href="#statement-${sIndex}">${escapeHtml(s.statement)}</a>
              </td>
              <td style="border:1px solid #ccc; padding:8px;">${veracity}</td>
              <td style="border:1px solid #ccc; padding:8px;">${totalProofsCount}</td>
            </tr>
          `;
        });
        tablePage += `</table></div>`;
    
        // Then detail pages for each statement
        let detailPages = "";
        savedStatements.forEach((s, sIndex) => {
          detailPages += `<div id="statement-${sIndex}"><h3>${escapeHtml(s.statement)}</h3></div>`;
          let factsArr = s.facts || [];
          let matArr = s.factsMateriality || [];
          let proofsArr = s.factsProofs || [];
    
          factsArr.forEach((fact, fIndex) => {
            let isTrueFact = matArr[fIndex];
            let labelTF = isTrueFact ? "true" : "false";
            detailPages += `<div style="font-weight:bold; margin:20px 0 8px 0;">
              Fact #${fIndex+1} - ${escapeHtml(fact)} (${labelTF})
            </div>`;
    
            if (isTrueFact && proofsArr[fIndex] && proofsArr[fIndex].length>0) {
              detailPages += `
                <table style="border-collapse: collapse; margin-bottom:30px; width:80%;">
                  <tr><th style="border:1px solid #ccc; padding:8px;">Materialities / Proofs</th></tr>
              `;
              proofsArr[fIndex].forEach(pr => {
                  // Transform any URL into <a href="..." target="_blank">LIEN</a>
                  const linkRegex = /(https?:\/\/[^\s]+)/g;
                  const proofWithLinks = escapeHtml(pr).replace(linkRegex, '<a href="$&" target="_blank">LINK</a>');
                  detailPages += `<tr>
                    <td style="border:1px solid #ccc; padding:8px;">
                      ${proofWithLinks}
                    </td>
                  </tr>`;
              });
              detailPages += `</table>`;
            } else if (isTrueFact) {
              detailPages += `<p>No materialities provided.</p>`;
            } else {
              detailPages += `<p>(Not applicable, fact declared false.)</p>`;
            }
            // Page-break after each fact
            detailPages += `<div style="page-break-after: always;"></div>`;
          });
        });
    
        // Put everything together
        let content = `
          <html>
            <head>
              <meta charset="UTF-8" />
              <title>${escapeHtml(fileName)}</title>
            </head>
            <body>
              ${coverPage}
              ${tablePage}
              ${detailPages}
            </body>
          </html>
        `;
    
        // Open a new tab, write content, set doc title for default PDF filename
        let newWin = window.open("", "_blank");
        newWin.document.write(content);
        newWin.document.close();
        newWin.document.title = fileName;
        newWin.focus();
        newWin.print();
        newWin.close();
    });

    function renderHistory() {
      if (savedStatements.length === 0) {
        historyContainer.style.display = "none";
        return;
      }
      historyContainer.style.display = "block";
      historyList.innerHTML = "";

      // Calculation of a “consolidated result” just for displaying the footer
      let totalCount = savedStatements.length;
      let sumVeracity = 0;
      savedStatements.forEach(s => {
        sumVeracity += s.verifiedPct;
      });
      let avgVeracity = totalCount > 0 ? Math.round(sumVeracity / totalCount) : 0;

      let consolidatedColor = "bg-red";
      if (avgVeracity > 90) consolidatedColor = "bg-green";
      else if (avgVeracity > 50) consolidatedColor = "bg-orange";

      let lineText = `Consolidated veracity: ${avgVeracity}%`;

      // We go through each statement
      savedStatements.forEach(s => {
        let item = document.createElement("div");
        item.className = "history-item";

        let colorClass = "bg-red";
        if (s.verifiedPct > 90) colorClass = "bg-green";
        else if (s.verifiedPct > 50) colorClass = "bg-orange";
        item.classList.add(colorClass);

        let labelDiv = document.createElement("div");
        labelDiv.className = "history-label";
        let veracityLabel = s.verifiedPct + "% true";
        labelDiv.textContent = s.statement + " : " + veracityLabel;

        let btnsDiv = document.createElement("div");
        btnsDiv.className = "history-item-buttons";

        let deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-button";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          savedStatements = savedStatements.filter(x => x.id !== s.id);
          deleteFromDB(s.id);
          renderHistory();
        });

        btnsDiv.appendChild(deleteBtn);
        item.appendChild(labelDiv);
        item.appendChild(btnsDiv);

        // When clicked to modify
        item.addEventListener("click", () => {
          loadStatementForEdit(s);
        });

        historyList.appendChild(item);
      });

      historyFooter.className = "history-footer " + consolidatedColor;
      historyFooter.textContent = lineText;
    }

    function saveCurrentStatement() {
      // If there is no ID yet, we assign a new autoIncrementID
      if (currentlyEditingID === null) {
        currentlyEditingID = autoIncrementID++;
      }
    
      // Build object with current ID
      let obj = {
        id: currentlyEditingID,
        statement: statement,
        facts: [...facts],
        factsMateriality: [...factsMateriality],
        factsProofs: JSON.parse(JSON.stringify(factsProofs)), // copie profonde
        verifiedPct: verifiedPct,
        isTrue: isStatementTrue
      };
    
      // We delete the old version if there was one with the same ID.
      savedStatements = savedStatements.filter(x => x.id !== obj.id);
    
      // Push the new version
      savedStatements.push(obj);
      
      // Save in database (IndexedDB)
      let txn = db.transaction(["statements"], "readwrite");
      let store = txn.objectStore("statements");
      store.put(obj);
    
      // Then refresh the history display
      renderHistory();
    }

    function loadStatementForEdit(s) {
      // Reset everything
      resetAllData();

      // Reset the ID of the element being edited
      currentlyEditingID = s.id; // c'est reparti en mode "édition"

      // Reload data
      statement = s.statement;
      facts = [...s.facts];
      factsMateriality = [...s.factsMateriality];
      factsProofs = s.factsProofs ? s.factsProofs.map(arr => [...arr]) : [];
      verifiedPct = s.verifiedPct;
      isStatementTrue = s.isTrue;

      // Refresh screen
      statementInput.value = statement;
      statementText.textContent = "Statement: " + statement;
      renderFacts();
      buildMaterialityList();
      buildProofsInterface();
      
      // Show the edit-mode message
      document.getElementById("edit-mode-message").style.display = "block";

      // Back to step 1
      goToStep(1);
    }

    function resetAllData() {
      // We remove the .active class at all stages
      for (let i = 1; i <= 5; i++) {
        steps[i].classList.remove("active");
      }
      // Then we reset our step counter
      currentStep = 1;
      steps[currentStep].classList.add("active");

      statement = "";
      facts = [];
      factsMateriality = [];
      factsProofs = [];
      
      verifiedCount = 0;
      verifiedPct = 0;
      isStatementTrue = false;

      currentlyEditingID = null;

      statementInput.value = "";
      statementText.textContent = "";
      factInput.value = "";
      factsList.innerHTML = "";
      materialityContainer.innerHTML = "";
      additionalProofWrapper.innerHTML = "";

      resultBox.textContent = "";
      resultBox.className = "result-box";
      
      // Hide the edit-mode message
      document.getElementById("edit-mode-message").style.display = "none";

      // Progress bar
      progressDots.forEach((d) => d.classList.remove("active"));
      progressDots[0].classList.add("active");
    }

    // ---------------------------
    // Divers utilitaires
    // ---------------------------
    function escapeHtml(str) {
      if (!str) return "";
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

  </script>
</body>
</html>
